<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>junkNAS Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f1115;
      color: #f2f5f8;
      margin: 20px;
    }
    h1, h2, h3 {
      margin: 0;
      padding: 0;
    }
    #subtitle {
      color: #97a0ad;
      margin-bottom: 1rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
      background: #151821;
      border: 1px solid #1f2430;
    }
    th, td {
      border: 1px solid #1f2430;
      padding: 10px;
      vertical-align: top;
    }
    th {
      background: #1d2230;
      text-align: left;
    }
    tr:nth-child(even) {
      background: #131722;
    }
    button {
      background: #2b3245;
      border: 1px solid #3b4356;
      color: #e9eef7;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #3a4259;
    }
    pre {
      white-space: pre-wrap;
      margin: 0;
    }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: 2fr 1fr;
      align-items: start;
    }
    .card {
      background: #121620;
      border: 1px solid #1f2430;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .card h2 {
      margin-bottom: 8px;
    }
    #nat-map {
      line-height: 1.6;
    }
    #setup-banner {
      background: #1f2a3a;
      border: 1px solid #3a4b65;
      padding: 10px 12px;
      border-radius: 6px;
      margin-top: 12px;
      margin-bottom: -4px;
      display: inline-block;
    }
    #setup-banner.hidden {
      display: none;
    }
    #setup-status, #merge-status {
      margin-top: 10px;
      color: #a9b5c5;
    }
    #merge-status.error {
      color: #f4a261;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background: #0f1420;
      border: 1px solid #2c3547;
      border-radius: 8px;
      padding: 20px;
      width: 420px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .modal-content label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    .modal-content input, .modal-content textarea, .merge-form textarea, .merge-form input {
      width: 100%;
      background: #161b29;
      border: 1px solid #2c3547;
      border-radius: 6px;
      color: #e9eef7;
      padding: 8px;
      margin-top: 6px;
    }
    .modal-actions {
      margin-top: 16px;
      text-align: right;
    }
    .modal-actions button:first-child {
      margin-right: 8px;
    }
    .merge-form textarea {
      min-height: 140px;
      resize: vertical;
    }
    .helper {
      color: #8d97a8;
      font-size: 0.9rem;
    }
    .hidden {
      display: none;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      background: #1a2130;
      border: 1px solid #28344a;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9rem;
      color: #dbe7ff;
    }
    .mini-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #samba-qr img {
      display: block;
      margin: 0 auto 10px auto;
      border: 1px solid #2c3547;
      border-radius: 8px;
      background: #0f1115;
      padding: 8px;
    }
    #samba-config-preview {
      background: #0f1420;
      border: 1px dashed #28344a;
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
      white-space: pre-wrap;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      color: #dbe7ff;
    }
    #samba-modal .modal-content {
      width: 520px;
    }
  </style>
</head>
<body>
  <h1 id="title">junkNAS</h1>
  <div id="subtitle">Loadingâ€¦</div>

  <div id="setup-banner" class="hidden"></div>
  <div id="setup-status"></div>

  <div class="grid">
    <div class="card">
      <h2>Devices in cluster</h2>
      <table id="nodes-table">
        <thead>
          <tr>
            <th>Node ID</th>
            <th>Hostname</th>
            <th>Nickname</th>
            <th>NAT Type</th>
            <th>Mesh Endpoint</th>
            <th>Mesh Score</th>
            <th>Drives</th>
            <th>Total Used</th>
            <th>Plan</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="nodes-body"></tbody>
      </table>
    </div>

    <div class="card">
      <div id="nat-map"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Samba sidecar access</h2>
      <p class="helper">Expose junkNAS over SMB without leaking cluster private keys. The dashboard shows the WireGuard peer info for the Samba sidecar so you can sync agents and desktop clients. The dashboard will generate a dedicated WireGuard private key for Samba clients so you never have to reuse the junkNAS mesh key.</p>
    <div id="samba-card" class="hidden">
      <div class="mini-grid">
        <div>
          <h3>WireGuard peer</h3>
          <div class="helper">These are safe to share with clients; private keys stay on junkNAS.</div>
          <div class="samba-meta">
            <div><strong>Sidecar public key:</strong> <span id="samba-public-key" class="pill"></span></div>
            <div><strong>Endpoint:</strong> <span id="samba-endpoint" class="pill"></span></div>
            <div><strong>Allowed IPs:</strong> <span id="samba-allowed" class="pill"></span></div>
            <div><strong>Client address:</strong> <span id="samba-address" class="pill"></span></div>
          </div>
        </div>
        <div>
          <h3>Mesh reference</h3>
          <div class="helper">Use these when cross-checking peers in the controller.</div>
          <div><strong>Controller public key:</strong> <span id="samba-mesh-public" class="pill"></span></div>
          <div id="samba-notes" class="helper" style="margin-top:6px;"></div>
        </div>
      </div>
      <div id="samba-config-preview"></div>
      <div style="text-align:right; margin-top:12px;">
        <button id="samba-connect">Connect via SAMBA</button>
      </div>
    </div>
    <div id="samba-missing" class="helper">No Samba sidecar metadata found. Set JUNKNAS_SAMBA_* vars in init-dashboard.sh to surface the WireGuard peer.</div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Cluster utilities</h2>
    <div class="merge-form">
      <h3>Merge junkNAS cluster</h3>
      <p class="helper">Paste a WireGuard configuration from the cluster you want to sync with. The dashboard will capture it so the device can join the chosen junkNAS cluster.</p>
      <label for="merge-cluster-name">Target cluster name</label>
      <input id="merge-cluster-name" placeholder="e.g. west-coast-lab" />
      <label for="merge-config">WireGuard config</label>
      <textarea id="merge-config" placeholder="[Interface]\nPrivateKey=...\n[Peer]\nPublicKey=...\nEndpoint=..."></textarea>
      <div style="margin-top:12px; text-align:right;">
        <button id="merge-submit">Merge into cluster</button>
      </div>
      <div id="merge-status"></div>
    </div>
  </div>

  <div id="setup-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>Set up new device</h2>
      <p id="setup-device-label" class="helper"></p>
      <label for="setup-nickname">Nickname</label>
      <input id="setup-nickname" placeholder="Backup NAS, Garage node, ..." />
      <label for="setup-allocation">Space allocation (GB)</label>
      <input id="setup-allocation" type="number" min="1" step="1" />
      <p class="helper">This dashboard stores your plan locally and reminds you when new devices appear.</p>
      <div class="modal-actions">
        <button id="setup-skip">Skip</button>
        <button id="setup-save">Save plan</button>
      </div>
    </div>
  </div>

  <div id="samba-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>Connect via SAMBA</h2>
      <p class="helper">Scan the QR code or download the WireGuard config for the Samba sidecar. The dashboard generates a fresh WireGuard private key for this config; do not reuse the junkNAS mesh private key for Samba access.</p>
      <div id="samba-qr"></div>
      <pre id="samba-config-block"></pre>
      <div class="modal-actions">
        <button id="samba-download">Download config file</button>
        <button id="samba-close">Done</button>
      </div>
    </div>
  </div>

  <script src="qrcode.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
